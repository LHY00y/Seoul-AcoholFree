<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>Main</title>
    <script type="text/javascript"
        src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=mdbxo3pu0t"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <!-- 행정구역 테두리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch-jsonp/1.1.3/fetch-jsonp.min.js"></script>
    <script>
        var map;
        var polyline;
        function findGuArea() {
            var selectGuName = document.getElementById("guSelect");
            var selectedValue = selectGuName.options[selectGuName.selectedIndex].value;
            var searchGu = "https://api.vworld.kr/req/data?service=data&request=GetFeature&data=LT_C_ADSIGG_INFO&key=D60D697E-DA1B-3C03-B045-CC469028D5FB&domain=127.0.0.1:8000/&attrFilter=sig_kor_nm:like:"+selectedValue;
            if(polyline){
                polyline.setMap(null);
            }
            // map = new naver.maps.Map('map', mapOptions);
            fetchJsonp(searchGu)
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    // 응답 데이터를 처리하고 지도에 경계선을 그리는 작업 수행
                    console.log(data); // 응답 데이터 콘솔에 출력
                    
                    // 경계선을 그리기 위한 좌표 데이터 추출
                    var coordinates = [];
                    console.log(coordinates)
                    var features = data.response.result.featureCollection.features;
                    for (var i = 0; i <  features[0].geometry.coordinates[0][0].length; i++) {
                        var feature = features[0].geometry.coordinates[0][0][i];
                        var x = feature[0];
                        var y = feature[1];
                        coordinates.push(new naver.maps.LatLng(y, x));
                        var location = new naver.maps.LatLng(features[0].geometry.coordinates[0][0][200])
                    }
                    // 경계선 생성
                    polyline = new naver.maps.Polyline({
                        path: coordinates,
                        strokeColor: '#0000FF', // 선 색
                        strokeOpacity: 0.8, // 투명도
                        strokeWeight: 6,
                        zIndex: 2,
                        clickable: true,
                        map: map // 위에서 생성한 지도에 추가
                    });
                    map.setCenter(location);
                })
                .catch(function(error) {
                    console.log('API 요청 중 오류 발생:', error);
                });
        }
    </script>
</head>

<body>
    <select id="guSelect">
        <option>선택</option>
        <option value="강남구">강남구</option>
        <option value="강동구">강동구</option>
        <option value="강북구">강북구</option>
        <option value="강서구">강서구</option>
        <option value="관악구">관악구</option>
        <option value="광진구">광진구</option>
        <option value="구로구">구로구</option>
        <option value="금천구">금천구</option>
        <option value="노원구">노원구</option>
        <option value="도봉구">도봉구</option>
        <option value="동대문구">동대문구</option>
        <option value="동작구">동작구</option>
        <option value="마포구">마포구</option>
        <option value="서대문구">서대문구</option>
        <option value="서초구">서초구</option>
        <option value="성동구">성동구</option>
        <option value="성북구">성북구</option>
        <option value="송파구">송파구</option>
        <option value="양천구">양천구</option>
        <option value="영등포구">영등포구</option>
        <option value="용산구">용산구</option>
        <option value="은평구">은평구</option>
        <option value="종로구">종로구</option>
        <option value="중구">중구</option>
        <option value="중랑구">중랑구</option>
        <!-- 추가적인 옵션들을 이곳에 나열할 수 있습니다 -->
    </select>
    <button class="findGuArea" onclick="findGuArea()">구 검색</button>
    <button onclick="location.href='/account/logout'">로그아웃</button>

    <button onclick="location.href='/account/register'">관리</button>


    <div id="map" style="width:80%;height:400px;"></div>
    <script>

        var mapOptions = {
            center: new naver.maps.LatLng(37.487400, 126.925651),
            zoom: 12,
            mapTypeId: 'normal',
            scaleControl: true,
            logoControl: false,
            mapDataControl: true,
            minZoom: 6, // 최소 줌
            zoomControl: true, // 줌 컨트롤 패널 보이기
            zoomControlOptions: {
                style: naver.maps.ZoomControlStyle.LARGE, // 줌 컨트롤 패널 크기
                position: naver.maps.Position.TOP_RIGHT // 줌 컨트롤 패널 위치
            }    
        };


        var map = new naver.maps.Map('map', mapOptions);

        var csvFile = '{{ "/static/data/AlcoholAccident.csv" }}';

        Papa.parse(csvFile, {
            download: true,
            complete: function (results) {
                var data = results.data;

                for (var i = 1; i < data.length; i++) {
                    var row = data[i];
                    var name = row[0];
                    // name : 주소
                    var latitude = parseFloat(row[1]);
                    // latitude : 경도
                    var longitude = parseFloat(row[2]);
                    // longitude : 위도
                    var count = parseInt(row[3]);

                    var location = new naver.maps.LatLng(latitude, longitude);

                    var marker = new naver.maps.Marker({
                        position: location,
                        map: map
                    });

                    var infowindow = new naver.maps.InfoWindow({
                        content: '<div style="padding:10px;">' + name + '</div>'
                    });

                    naver.maps.Event.addListener(marker, 'click', (function (marker, infowindow) {
                        return function () {
                            infowindow.open(map, marker);
                        };
                    })(marker, infowindow));
                }
            }
        });

        function store_marker(x, y) {
            var marker = new naver.maps.Marker({
                position: new naver.maps.LatLng(x, y),
                map: map
            });
        }
        function park_site(x,y){
            var marker=new naver.maps.Marker({
                position: new naver.maps.LatLng(x,y),
                map: map
            });
        }//주차장 출력(안됨)
    </script>

    {% for x in store_dt %}
    <script>
        store_marker({{ x.위도 }}, {{ x.경도 }})
    </script>

    {% endfor %}
    {% for i in parks%}
    <script>
        park_site({{i.LAT}},{{i.LNG}})
    </script>
    {% endfor %}

</body>

</html>